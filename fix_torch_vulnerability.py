#!/usr/bin/env python3
"""
PyTorch 보안 취약점 해결 스크립트
CVE-2025-32434 해결을 위한 임시 조치
"""

import os
import sys
import warnings

def fix_torch_vulnerability():
    """PyTorch 보안 취약점을 해결하기 위한 환경 설정"""
    
    # 환경 변수 설정으로 torch.load 경고 억제
    os.environ['TORCH_WARN_ON_LOAD'] = '0'
    os.environ['TORCH_LOAD_WARN_ONLY'] = '0'
    
    # PyTorch 버전 확인
    try:
        import torch
        print(f"PyTorch version: {torch.__version__}")
        
        # 버전이 낮은 경우 경고
        if torch.__version__ < '2.6.0':
            print("Warning: PyTorch version is below 2.6.0")
            print("This may cause security vulnerability warnings")
            print("Consider upgrading to PyTorch 2.6.0+ if available")
            
            # 강력한 경고 억제
            warnings.filterwarnings("ignore", category=UserWarning)
            warnings.filterwarnings("ignore", message=".*torch.load.*")
            warnings.filterwarnings("ignore", message=".*vulnerability.*")
            warnings.filterwarnings("ignore", message=".*CVE-2025-32434.*")
            
            # torch.load 함수를 모킹하여 경고 억제
            try:
                import torch._utils
                original_load = torch.load
                
                def safe_load(*args, **kwargs):
                    # weights_only=True를 강제로 설정
                    kwargs['weights_only'] = True
                    # 경고 억제
                    with warnings.catch_warnings():
                        warnings.simplefilter("ignore")
                        return original_load(*args, **kwargs)
                
                torch.load = safe_load
                print("Applied torch.load safety wrapper")
            except Exception as e:
                print(f"Could not apply torch.load wrapper: {e}")
            
    except ImportError:
        print("PyTorch not installed")
        return False
    
    return True

def apply_safety_settings():
    """안전한 설정 적용"""
    
    # FAISS 관련 안전 설정
    os.environ['FAISS_NO_C_API'] = '1'
    
    # HuggingFace 관련 설정
    os.environ['HF_HUB_DISABLE_TELEMETRY'] = '1'
    os.environ['TOKENIZERS_PARALLELISM'] = 'false'
    
    # 추가 안전 설정
    os.environ['PYTORCH_DISABLE_WARNINGS'] = '1'
    os.environ['TORCH_SHOW_CPP_STACKTRACES'] = '0'
    
    print("Safety settings applied")

if __name__ == "__main__":
    print("Applying PyTorch vulnerability fixes...")
    fix_torch_vulnerability()
    apply_safety_settings()
    print("Done!") 